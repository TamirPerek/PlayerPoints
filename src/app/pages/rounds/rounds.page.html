<main class="page">
  <header class="page-header">
    <div>
      <h1>Runden</h1>
      <p>Punkte je Runde erfassen.</p>
    </div>
    <a routerLink="/" class="link">Zurück</a>
  </header>

  <section class="card" *ngIf="game.players.length; else noPlayers">
    <form class="round-form" (ngSubmit)="addRound()">
      <div class="field" *ngFor="let player of game.players">
        <label [for]="player.id">{{ player.name }}</label>
        <input
          type="number"
          inputmode="text"
          pattern="-?[0-9]+"
          [id]="player.id"
          [(ngModel)]="scores[player.id]"
          name="score-{{ player.id }}"
          required
        />
      </div>
      <button type="submit">Runde hinzufügen</button>
    </form>
  </section>
  <ng-template #noPlayers>
    <div class="card muted">Lege zuerst Spieler an.</div>
  </ng-template>

  <section class="card" *ngIf="game.rounds.length">
    <div class="section-head">
      <h2>Erfasste Runden</h2>
      <button class="link-btn danger" type="button" (click)="clearRounds()">
        Runden löschen
      </button>
    </div>
    <div class="round-list">
      <div class="round" *ngFor="let round of game.rounds; index as i">
        <div class="round-header">
          <span>Runde {{ i + 1 }}</span>
          <div class="round-actions">
            <button class="link-btn" type="button" (click)="toggleEdit(round.id)">
              {{ editingRoundId === round.id ? 'Abbrechen' : 'Bearbeiten' }}
            </button>
            <button class="link-btn danger" type="button" (click)="deleteRound(round.id)">
              Löschen
            </button>
          </div>
        </div>

        <div class="round-scores" *ngIf="editingRoundId !== round.id">
          <div *ngFor="let player of game.players">
            <strong>{{ player.name }}: </strong>
            <span>{{ round.scores[player.id] ?? 0 }}</span>
          </div>
        </div>

        <div class="round-totals" *ngIf="editingRoundId !== round.id">
          <div class="round-totals-title">Zwischenstand nach Runde {{ i + 1 }}</div>
          <div class="round-scores">
            <div *ngFor="let player of game.players">
              <strong>{{ player.name }}: </strong>
              <span>{{ partialTotals(i)[player.id] }}</span>
            </div>
          </div>
        </div>

        <form
          *ngIf="editingRoundId === round.id"
          class="edit-form"
          (ngSubmit)="saveEdit(round.id)"
        >
          <div class="edit-grid">
            <div class="field" *ngFor="let player of game.players">
              <label [for]="'edit-' + round.id + '-' + player.id">{{ player.name }}</label>
              <input
                type="number"
                inputmode="text"
                pattern="-?[0-9]*"
                [id]="'edit-' + round.id + '-' + player.id"
                [(ngModel)]="editBuffer[player.id]"
                name="edit-{{ round.id }}-{{ player.id }}"
                required
              />
            </div>
          </div>
          <div class="edit-actions">
            <button type="submit">Speichern</button>
            <button type="button" class="secondary" (click)="cancelEdit()">Abbrechen</button>
          </div>
        </form>
      </div>
    </div>
  </section>
</main>
