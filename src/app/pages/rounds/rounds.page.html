<main class="page">
  <app-header
    [title]="'rounds.title' | translate"
    [subtitle]="'rounds.subtitle' | translate"
    [showBackButton]="true">
  </app-header>

  @if (game.players.length) {
    <app-card>
      <form class="round-form" (ngSubmit)="addRound()">
        @for (player of game.players; track player) {
          <div class="field">
            <label [for]="player.id">{{ player.name }}</label>
            <input
              type="number"
              inputmode="text"
              pattern="-?[0-9]+"
              [id]="player.id"
              [(ngModel)]="scores[player.id]"
              name="score-{{ player.id }}"
              required
            />
          </div>
        }
        <app-button type="submit">{{ 'rounds.addRound' | translate }}</app-button>
        @if (game.rounds.length) {
          <app-button buttonClass="alert" (click)="finalizeGame()"
                      (keydown)="finalizeGame()">{{ 'rounds.finalizeGame' | translate }}
          </app-button>
        }
      </form>
    </app-card>
  } @else {
    <div class="card muted">{{ 'rounds.noPlayers' | translate }}</div>
  }

  @if (game.rounds.length) {
    <app-card>
      <div class="round-totals">
        <div class="round-totals-title">{{ 'rounds.totalsAfter' | translate }} {{ game.rounds.length }}</div>
        <div class="round-scores">
          <br>
          @for (player of sortedPlayers(); track player; let i = $index) {
            <div class="score-row">
              @if (player.id === this.game.getWinner()?.player?.id) {
                <div class="winner-name">
                  <strong>{{i + 1}}. {{ player.name }}</strong>
                </div>
              } @else {
                <div class="player-name">{{i + 1}}. {{ player.name }}</div>
              }
              <div class="score-value">{{ totals()[player.id] }}</div>
            </div>
          }
        </div>
      </div>
    </app-card>
    <app-card>
      <div class="section-head">
        <h2>{{ 'rounds.title2' | translate }}</h2>
        <button class="link-btn danger" type="button" (click)="clearRounds()">
          {{ 'rounds.deleteRounds' | translate }}
        </button>
      </div>
      <div class="round-list">
        @for (round of game.rounds; track round; let i = $index) {
          <div class="round">
            <div class="round-header">
              <span>{{ 'rounds.round' | translate }} {{ i + 1 }}</span>
              <div class="round-actions">
                <button class="link-btn" type="button" (click)="toggleEdit(round.id)">
                  {{ editingRoundId === round.id ? ('rounds.cancel' | translate) : 'rounds.edit' | translate }}
                </button>
                <button class="link-btn danger" type="button" (click)="deleteRound(round.id)">
                  {{ 'rounds.delete' | translate }}
                </button>
              </div>
            </div>

            @if (editingRoundId !== round.id) {
              <div class="round-scores">
                @for (player of game.players; track player) {
                  <div>
                    <strong>{{ player.name }}: </strong>
                    <span>{{ round.scores[player.id] ?? 0 }}</span>
                  </div>
                }
              </div>
            } @else {
              <form
                class="edit-form"
                (ngSubmit)="saveEdit(round.id)"
              >
                <div class="edit-grid">
                  @for (player of game.players; track player) {
                    <div class="field">
                      <label [for]="'edit-' + round.id + '-' + player.id">{{ player.name }}</label>
                      <input
                        type="number"
                        inputmode="text"
                        pattern="-?[0-9]*"
                        [id]="'edit-' + round.id + '-' + player.id"
                        [(ngModel)]="editBuffer[player.id]"
                        name="edit-{{ round.id }}-{{ player.id }}"
                        required
                      />
                    </div>
                  }
                </div>
                <div class="edit-actions">
                  <app-button type="submit">{{ 'rounds.save' | translate }}</app-button>
                  <app-button type="button" buttonClass="secondary" (click)="cancelEdit()"
                              (keydown)="cancelEdit()">{{ 'rounds.cancel' | translate }}
                  </app-button>
                </div>
              </form>
            }
          </div>
        }
      </div>
    </app-card>
  }
</main>
